{"version":3,"file":"upload.js","sources":["utils/upload.js"],"sourcesContent":["import store from '@/store'\r\nimport config from '@/config'\r\nimport { getToken } from '@/utils/auth'\r\nimport errorCode from '@/utils/errorCode'\r\nimport { toast, showConfirm, tansParams } from '@/utils/common'\r\n\r\nlet timeout = 10000\r\nconst baseUrl = config.baseUrl\r\n\r\nconst upload = config => {\r\n  // 是否需要设置 token\r\n  const isToken = (config.headers || {}).isToken === false\r\n  config.header = config.header || {}\r\n  if (getToken() && !isToken) {\r\n    config.header['Authorization'] = 'Bearer ' + getToken()\r\n  }\r\n  // get请求映射params参数\r\n  if (config.params) {\r\n    let url = config.url + '?' + tansParams(config.params)\r\n    url = url.slice(0, -1)\r\n    config.url = url\r\n  }\r\n  return new Promise((resolve, reject) => {\r\n      uni.uploadFile({\r\n        timeout: config.timeout || timeout,\r\n        url: baseUrl + config.url,\r\n        filePath: config.filePath,\r\n        name: config.name || 'file',\r\n        header: config.header,\r\n        formData: config.formData,\r\n        success: (res) => {\r\n          let result = JSON.parse(res.data)\r\n          const code = result.code || 200\r\n          const msg = errorCode[code] || result.msg || errorCode['default']\r\n          if (code === 200) {\r\n            resolve(result)\r\n          } else if (code == 401) {\r\n            showConfirm(\"登录状态已过期，您可以继续留在该页面，或者重新登录?\").then(res => {\r\n              if (res.confirm) {\r\n                store.dispatch('LogOut').then(res => {\r\n                  uni.reLaunch({ url: '/pages/login/login' })\r\n                })\r\n              }\r\n            })\r\n            reject('无效的会话，或者会话已过期，请重新登录。')\r\n          } else if (code === 500) {\r\n            toast(msg)\r\n            reject('500')\r\n          } else if (code !== 200) {\r\n            toast(msg)\r\n            reject(code)\r\n          }\r\n        },\r\n        fail: (error) => {\r\n          let { message } = error\r\n          if (message == 'Network Error') {\r\n            message = '后端接口连接异常'\r\n          } else if (message.includes('timeout')) {\r\n            message = '系统接口请求超时'\r\n          } else if (message.includes('Request failed with status code')) {\r\n            message = '系统接口' + message.substr(message.length - 3) + '异常'\r\n          }\r\n          toast(message)\r\n          reject(error)\r\n        }\r\n      })\r\n  })\r\n}\r\n\r\nexport default upload\r\n"],"names":["config","getToken","tansParams","uni","errorCode","showConfirm","res","store","toast"],"mappings":";;;;;;;AAMA,IAAI,UAAU;AACd,MAAM,UAAUA,OAAM,OAAC;AAElB,MAAC,SAAS,CAAAA,YAAU;AAEvB,QAAM,WAAWA,QAAO,WAAW,CAAE,GAAE,YAAY;AACnD,EAAAA,QAAO,SAASA,QAAO,UAAU,CAAE;AACnC,MAAIC,WAAQ,SAAA,KAAM,CAAC,SAAS;AAC1B,IAAAD,QAAO,OAAO,eAAe,IAAI,YAAYC,WAAAA,SAAU;AAAA,EACxD;AAED,MAAID,QAAO,QAAQ;AACjB,QAAI,MAAMA,QAAO,MAAM,MAAME,aAAU,WAACF,QAAO,MAAM;AACrD,UAAM,IAAI,MAAM,GAAG,EAAE;AACrB,IAAAA,QAAO,MAAM;AAAA,EACd;AACD,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACpCG,kBAAAA,MAAI,WAAW;AAAA,MACb,SAASH,QAAO,WAAW;AAAA,MAC3B,KAAK,UAAUA,QAAO;AAAA,MACtB,UAAUA,QAAO;AAAA,MACjB,MAAMA,QAAO,QAAQ;AAAA,MACrB,QAAQA,QAAO;AAAA,MACf,UAAUA,QAAO;AAAA,MACjB,SAAS,CAAC,QAAQ;AAChB,YAAI,SAAS,KAAK,MAAM,IAAI,IAAI;AAChC,cAAM,OAAO,OAAO,QAAQ;AAC5B,cAAM,MAAMI,gBAAAA,UAAU,IAAI,KAAK,OAAO,OAAOA,gBAAS,UAAC,SAAS;AAChE,YAAI,SAAS,KAAK;AAChB,kBAAQ,MAAM;AAAA,QAC1B,WAAqB,QAAQ,KAAK;AACtBC,uBAAAA,YAAY,4BAA4B,EAAE,KAAK,CAAAC,SAAO;AACpD,gBAAIA,KAAI,SAAS;AACfC,0BAAAA,MAAM,SAAS,QAAQ,EAAE,KAAK,CAAAD,SAAO;AACnCH,8BAAAA,MAAI,SAAS,EAAE,KAAK,qBAAoB,CAAE;AAAA,cAC5D,CAAiB;AAAA,YACF;AAAA,UACf,CAAa;AACD,iBAAO,sBAAsB;AAAA,QACzC,WAAqB,SAAS,KAAK;AACvBK,uBAAAA,MAAM,GAAG;AACT,iBAAO,KAAK;AAAA,QACxB,WAAqB,SAAS,KAAK;AACvBA,uBAAAA,MAAM,GAAG;AACT,iBAAO,IAAI;AAAA,QACZ;AAAA,MACF;AAAA,MACD,MAAM,CAAC,UAAU;AACf,YAAI,EAAE,QAAO,IAAK;AAClB,YAAI,WAAW,iBAAiB;AAC9B,oBAAU;AAAA,QACX,WAAU,QAAQ,SAAS,SAAS,GAAG;AACtC,oBAAU;AAAA,QACX,WAAU,QAAQ,SAAS,iCAAiC,GAAG;AAC9D,oBAAU,SAAS,QAAQ,OAAO,QAAQ,SAAS,CAAC,IAAI;AAAA,QACzD;AACDA,qBAAAA,MAAM,OAAO;AACb,eAAO,KAAK;AAAA,MACb;AAAA,IACT,CAAO;AAAA,EACP,CAAG;AACH;;"}